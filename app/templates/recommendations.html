{% extends "base.html" %}

{% block content %}
<div class="mt-4">
    <div class="grid grid-cols-1 gap-4 mb-4">
        <div>
            <h2>Recommended Professionals</h2>
            <p class="text-gray-600">Top professionals matched for your job requirements</p>
        </div>
    </div>

    <!-- Filters -->
    <div class="bg-white rounded-lg shadow-soft p-4 mb-4">
        <div class="p-4">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
                <div>
                    <label for="maxDistance" class="block text-sm font-medium text-gray-700">Max Distance (km)</label>
                    <input type="range" class="form-range" min="1" max="100" value="50" id="maxDistance">
                    <div class="text-center"><span id="distanceValue">50</span> km</div>
                </div>
                <div>
                    <label for="minRating" class="block text-sm font-medium text-gray-700">Minimum Rating</label>
                    <div class="flex items-center">
                        <input type="range" class="form-range" min="0" max="5" step="0.5" value="4" id="minRating">
                        <span class="ml-2" id="ratingValue">4.0</span>
                        <i class="fas fa-star text-warning ml-1"></i>
                    </div>
                </div>
                <div class="flex items-end">
                    <button class="btn btn-primary w-full" onclick="loadRecommendations()">
                        <i class="fas fa-sync-alt mr-2"></i>Update Results
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Loading Indicator -->
    <div id="loadingIndicator" class="text-center my-5" style="display: none;">
        <div class="spinner-border text-primary" role="status">
            <span class="sr-only">Loading...</span>
        </div>
        <p class="mt-2">Finding the best professionals for you...</p>
    </div>

    <!-- Results Container -->
    <div id="recommendations" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
        <!-- Recommendations will be inserted here -->
    </div>

    <!-- No Results Message -->
    <div id="noResults" class="text-center py-5" style="display: none;">
        <i class="fas fa-search text-4xl text-gray-500 mb-3"></i>
        <h4>No professionals found</h4>
        <p class="text-gray-500">Try adjusting your filters or check back later.</p>
    </div>

    <!-- Error Message -->
    <div id="errorMessage" class="bg-danger/20 text-danger p-4 rounded-md mt-4" style="display: none;">
        <i class="fas fa-exclamation-circle mr-2"></i>
        <span id="errorText">An error occurred while loading recommendations.</span>
    </div>
</div>

<!-- Professional Card Template (Hidden) -->
<template id="proCardTemplate">
    <div class="w-full">
        <div class="bg-white rounded-lg shadow-soft h-full">
            <div class="p-4">
                <div class="flex">
                    <img src="{{ url_for('static', filename='img/default-avatar.png') }}" 
                         class="rounded-full mr-3" 
                         width="64" 
                         height="64" 
                         alt="Professional"
                         onerror="this.src='{{ url_for('static', filename='img/default-avatar.png') }}'">
                    <div>
                        <h5 class="font-semibold text-lg mb-1">
                            <a href="#" class="no-underline professional-name"></a>
                            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-success text-white ml-2 professional-rating"></span>
                        </h5>
                        <p class="text-gray-600 mb-1 professional-profession"></p>
                        <p class="text-gray-600 text-sm mb-2">
                            <i class="fas fa-map-marker-alt mr-1"></i> 
                            <span class="professional-distance"></span> km away â€¢ 
                            <span class="professional-reviews"></span> reviews
                        </p>
                    </div>
                </div>
                
                <div class="mt-3">
                    <div class="flex justify-between items-center mb-2">
                        <span class="text-gray-600">Match Score:</span>
                        <div class="w-full h-5 bg-gray-200 rounded-full overflow-hidden flex-grow mx-2">
                            <div class="h-full bg-success professional-score-bar" role="progressbar" style="width: 0%"></div>
                        </div>
                        <span class="professional-score"></span>
                    </div>
                    
                    <div class="mb-3">
                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-light text-dark mr-1 mb-1">
                            <i class="fas fa-briefcase mr-1"></i> 
                            <span class="professional-experience"></span> years
                        </span>
                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-light text-dark mr-1 mb-1">
                            <i class="fas fa-dollar-sign mr-1"></i> 
                            $<span class="professional-rate"></span>/hr
                        </span>
                    </div>
                    
                    <div class="flex flex-wrap gap-1 mb-3">
                        <!-- Skills will be inserted here -->
                    </div>
                </div>
                
                <div class="grid gap-2">
                    <button class="btn btn-outline-primary text-sm">
                        <i class="far fa-envelope mr-1"></i> Contact
                    </button>
                    <button class="btn btn-primary text-sm">
                        <i class="far fa-calendar-alt mr-1"></i> Book Now
                    </button>
                </div>
            </div>
        </div>
    </div>
</template>

<!-- Skill Badge Template (Hidden) -->
<template id="skillBadgeTemplate">
    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-light text-dark mr-1 mb-1"></span>
</template>



<script>
document.addEventListener('DOMContentLoaded', function() {
    // Update slider values
    document.getElementById('maxDistance').addEventListener('input', function() {
        document.getElementById('distanceValue').textContent = this.value;
    });
    
    document.getElementById('minRating').addEventListener('input', function() {
        document.getElementById('ratingValue').textContent = this.value;
    });
    
    // Load recommendations when page loads
    const urlParams = new URLSearchParams(window.location.search);
    const jobId = urlParams.get('job_id');
    if (jobId) {
        loadRecommendations(jobId);
    }
});

function loadRecommendations(jobId) {
    if (!jobId) {
        jobId = new URLSearchParams(window.location.search).get('job_id');
    }
    
    if (!jobId) {
        showError('No job ID specified');
        return;
    }
    
    const maxDistance = document.getElementById('maxDistance').value;
    const minRating = document.getElementById('minRating').value;
    
    // Show loading state
    document.getElementById('loadingIndicator').style.display = 'block';
    document.getElementById('recommendations').innerHTML = '';
    document.getElementById('noResults').style.display = 'none';
    document.getElementById('errorMessage').style.display = 'none';
    
    // Build query parameters
    const params = new URLSearchParams({
        max_distance: maxDistance,
        min_rating: minRating,
        limit: 12
    });
    
    // Make API request
    fetch(`/api/jobs/${jobId}/recommendations?${params}`)
        .then(handleResponse)
        .then(data => {
            displayRecommendations(data);
        })
        .catch(error => {
            console.error('Error:', error);
            showError('Failed to load recommendations. Please try again.');
        })
        .finally(() => {
            document.getElementById('loadingIndicator').style.display = 'none';
        });
}

function handleResponse(response) {
    if (!response.ok) {
        return response.json().then(err => {
            throw new Error(err.error || 'Network response was not ok');
        });
    }
    return response.json();
}

function displayRecommendations(data) {
    const container = document.getElementById('recommendations');
    const template = document.getElementById('proCardTemplate');
    const skillTemplate = document.getElementById('skillBadgeTemplate');
    
    if (!data.recommendations || data.recommendations.length === 0) {
        document.getElementById('noResults').style.display = 'block';
        return;
    }
    
    container.innerHTML = ''; // Clear existing content
    
    data.recommendations.forEach(pro => {
        // Clone the template
        const card = template.content.cloneNode(true);
        
        // Fill in the data
        card.querySelector('.professional-name').textContent = pro.name;
        card.querySelector('.professional-profession').textContent = pro.profession;
        card.querySelector('.professional-rating').textContent = pro.rating?.toFixed(1) || 'N/A';
        card.querySelector('.professional-distance').textContent = pro.distance_km?.toFixed(1) || 'N/A';
        card.querySelector('.professional-reviews').textContent = pro.total_reviews || 0;
        card.querySelector('.professional-experience').textContent = pro.years_experience || 0;
        card.querySelector('.professional-rate').textContent = pro.hourly_rate?.toFixed(2) || 'N/A';
        
        // Set match score
        const scorePercent = Math.round(pro.score * 100);
        card.querySelector('.professional-score').textContent = `${scorePercent}%`;
        card.querySelector('.professional-score-bar').style.width = `${scorePercent}%`;
        
        // Set professional image if available
        if (pro.photo && pro.photo !== 'default_profile.png') {
            const img = card.querySelector('img');
            img.src = `/static/uploads/profiles/${pro.photo}`;
        }
        
        // Add skills
        const skillsContainer = card.querySelector('.skills-container');
        if (pro.skills && pro.skills.length > 0) {
            // Limit to first 5 skills
            const skillsToShow = pro.skills.slice(0, 5);
            skillsToShow.forEach(skill => {
                const skillBadge = skillTemplate.content.cloneNode(true);
                const badge = skillBadge.querySelector('.badge');
                badge.textContent = skill;
                skillsContainer.appendChild(skillBadge);
            });
            
            // Add +X more if there are additional skills
            if (pro.skills.length > 5) {
                const moreBadge = document.createElement('span');
                moreBadge.className = 'badge bg-light text-dark';
                moreBadge.textContent = `+${pro.skills.length - 5} more`;
                skillsContainer.appendChild(moreBadge);
            }
        }
        
        // Add event listeners for buttons
        const contactBtn = card.querySelector('.btn-outline-primary');
        const bookBtn = card.querySelector('.btn-primary');
        
        contactBtn.addEventListener('click', (e) => {
            e.preventDefault();
            // TODO: Implement contact functionality
            console.log('Contact:', pro.id);
        });
        
        bookBtn.addEventListener('click', (e) => {
            e.preventDefault();
            // TODO: Implement booking functionality
            console.log('Book:', pro.id);
        });
        
        container.appendChild(card);
    });
}

function showError(message) {
    const errorElement = document.getElementById('errorMessage');
    document.getElementById('errorText').textContent = message;
    errorElement.style.display = 'block';
}

// Export for testing
window.recommendationsModule = {
    loadRecommendations,
    displayRecommendations,
    showError
};
</script>
{% endblock %}
